# Составление планшетов водоисточников
## Маркеры пожарных гидрантов
Воспользуемся уже имеющейся тайловой картой, которую создали пунктами выше, либо создадим полностью новый проект в NextGIS QGIS. Открываем в панели инструментов «Слой» - «Создать слой» - «Создать слой» - «GeoPackage».

![](pictures/1.png)

В открывшемся окне, нажав на 3 точки выбираем путь сохранения файла, в нашем примере создадим папку fire_data и в ней будем размещать все слои, которые будут относится к пожарной охране. 

***Почему именно «data»?***

*По негласным правилам работы с приложениями QGIS, NextGIS QGIS, в папке проекта создаётся другая папка с названием «data» и в неё помещаются все файлы, связанные со слоями.*

Создадим в файле с проектом папку data для удобности работы с векторными слоями, ибо папка fire_data будет заполнена тайловыми слоями.

После создания двух папок, сохраняем слой GeoPackage с произвольным названием fire_data.

![](pictures/2.png)

Далее называем имя таблицы. В примере назовём её «Водоисточники». Выбираем тип геометрии «Точка» и нажимаем «ОК».

![](pictures/3.png)

Создадим наш первый водоисточник! Нажимаем на слой с водоисточниками, переходим в «Режим редактирования» и в появившемся инструменте выбираем «Добавить точечный объект».

![](pictures/4.png)

Выбираем место, где будет располагаться наш водоисточник. Нажимаем левой кнопкой мыши на выбранное место и в открывшемся окне нажимаем «ОК». У нас появилась точка. Нажимаем ещё раз на «Режим редактирования» и сохраняем слой.

![](pictures/5.png)

Займёмся стилизацией водоисточников. Нажимаем на слой «Водоисточники» правой кнопкой мыши и из открывшегося меню выбираем «Свойства».

![](pictures/6.png)

У нас открывается диалоговое окно с множеством настроек, нам понадобится свойство «Стиль», где есть возможность редактирования маркера. Во вкладке «Маркер» поменяем цвет маркеру, например на красный.

![](pictures/7.png)

В пожарной охране есть установленные условные обозначения водоисточников, поменяем наши точки под установленный образец. Нажимаем на «Простой маркер», выбираем тип слоя «SVG маркер» и внизу у нас появился перечень возможных вариантов.

![](pictures/8.png)

Для нужного нам условного обозначения, нужно скачать векторные изображения в формате svg с АИГС ГраФиС. Заходим в GitHub по ссылке:

https://github.com/Obsidian-pb/GraFiS_svg

На открывшейся веб-странице во вкладке «Releases» нажимаем v.0.8.0.

![](pictures/9.png)

Скачиваем .zip файл:

![](pictures/10.png)

В файле открываем папку icons и в ней мы перемещаем папку water_sources в папку с нашей работой.

![](pictures/11.png)

Переходим обратно в редактор SVG маркеров. В самом низу указываем путь к нашему маркеру, возьмём обозначение пожарного гидранта – это файл pg.svg. После этого нажимаем на «Открыть», «Применить» и потом «ОК».

![](pictures/12.png)

В архиве находится описание остальных обозначений, нужных для работы.

Наблюдаем, что пожарные гидранты обозначаются согласно установленным нормам. По желанию возможно изменение размера в свойствах слоя.

![](pictures/13.png)

![](pictures/14.png)

## Стилизация маркеров
В данном разделе сделаем все условные обозначения для ИННПВ. Выбираем слой наших водоисточников и открываем таблицу атрибутов.

![](pictures/15.png)

В таблице атрибутов отображаются все атрибуты векторного слоя, которые размещены на карте. Сейчас находится только один атрибут и это id векторного слоя. Мы можем добавлять любую произвольную информацию в произвольном виде. Добавим поле для типа водоисточника. Для этого в таблице атрибутов нажимаем на «Режим редактирования» и нажимаем «Добавить новое поле».

![](pictures/16.png)

В открывшемся окне пишем имя «Тип» и в выпадающем списке «Тип» выбираем «Текст», в длине пишем 10. Нажимаем «ОК».

![](pictures/17.png)

У нас появилось новое поле, где мы можем написать тип ИННПВ (ПГ, ПВ и т.д.). По желанию заполняем данные. Сейчас мы это делаем вручную, посмотрим способ как автоматизировать этот процесс. Выходим из режима редактирования и сохраняем изменения.

Переходим в свойства слоя водоисточников и выбираем вкладку «Формы полей»

![](pictures/18.png)

Переходим в поле «Тип», далее во вкладке «Вид формы» из выпадающего списка выбираем «Карта значений». Далее в столбце «Значение» и «Описание» вводим все типы ИННПВ. После ввода нажимаем «Применить» и «ОК».

![](pictures/19.png)

Теперь обратно переходим в таблицу атрибутов слоя и наблюдаем, что тип водоисточников теперь выбирается из выпадающего списка. Заполняем поле. Обратите внимание, что заполнить поле возможно только в режиме редактирования!

![](pictures/20.png)

Для того, чтобы найти водоисточник на карте, мы нажимаем правой кнопкой мыши на желаемый водоисточник в таблице атрибутов и выбираем «Помигать объектом» после этого рядом с нужным гидрантом будет пульсировать красный свет.

![](pictures/21.png)

Либо выбираем «Переместиться к объекту» и камера переместит нас на нужный водоисточник.

Теперь разберёмся как сделать, чтобы от типа водоисточника менялась его иконка.

Переходим в свойства слоя во вкладку «Стиль». Сверху выбираем «Символизация по уникальным значениям».

![](pictures/22.png)

Выбираем значение поля «Тип» и нажимаем «Классифицировать». У нас появились все возможные типы ИННПВ. Сначала выбираем «все другие значения» и нажимаем на минус, чтобы удалить. Теперь меняем все иконки для каждого типа, как мы делали с пожарным гидрантом, пунктами выше. Чтобы перейти в настройки маркера, нужно два раза нажать на знак, который будет изменяться.

![](pictures/23.png)

После выбора всех условных обозначений нажимаем «Применить» и «ОК». Наблюдаем что поменялось на карте. Теперь типы водоисточников разделились на отдельные слои, с которыми можно отдельно работать ( например, скрыть, убрав галочку.)

![](pictures/24.png)

Для того, чтобы узнать количество водоисточников, нажимаем правой кнопкой мыши на слой «Водоисточники» и выбираем пункт «Показывать количество объектов».

![](pictures/25.png)

***Важный момент:*** *сейчас все пути к иконкам водоисточников указаны абсолютно, т.е. при перемещении на другое рабочее пространство возникнут проблемы с отображением. Поэтому путь к иконкам меняем по примеру:*

При необходимости возможно удалить и переместить маркер. Для перемещения необходимо перейти на нужный слой, войти в режим редактирования и выбрать инструмент «Инструмент редактирования вершин в текущем слое». Выбираем нужный водоисточник и перемещаем в нужное место.

![](pictures/26.jpg)

Для удаления остаёмся в режиме редактирование, выбираем инструмент «Выбрать объекты в прямоугольнике или точке» и выделяем нужные для удаления водоисточники. 

![](pictures/27.jpg)

Далее переходим в таблицу атрибутов, переходим в режим редактирования и нажимаем на «Удалить выбранные объекты».

![](pictures/28.jpg)

## Попдиси маркеров
Разберёмся с подписями ИННПВ. Открываем таблицу атрибутов слоя водоисточников и добавим новое поле. В прошлый раз мы добавляли поле через свойство слоя, теперь же для разнообразия добавим его через таблицу атрибутов. Включаем режим редактирования и создаём новое текстовое поле с именем «Подпись», сделаем для этого поля размер 25, нажимаем «ОК». Пока что пишем просто произвольные подписи. Сохраняем, закрываем режим редактирования и выходим из таблицы атрибутов.

![](pictures/29.png)

При выходе из таблицы атрибутов, наблюдаем, что ничего не появилось. Теперь мы покажем сведения в атрибуте в качестве подписей водоисточников. Открываем свойство слоя и переходим на вкладку «Подписи».

![](pictures/30.png)

Сверху в выпадающем списке выбираем «Обычные подписи», далее выбираем поле из которых будет дублироваться подпись, т.е. атрибут «Подпись». Переходим в редактирование текста и сделаем текст синим. Нажимаем «Применить» и «ОК».

![](pictures/31.png)

Наблюдаем за изменениями.

![](pictures/32.png)

Для улучшения чёткости отображения надписей сделаем текст полужирным, а также перейдём во вкладку «Буфер» и поставим галочку на «Буферизовать подписи». Нажимаем «Применить». 

![](pictures/33.jpg)

Переместим подпись водоисточников в более удобное место. Для этого переходим во вкладку «Размещение», выбираем режим «На расстоянии от точки» и во вкладке «Сектор» выбираем функцию сверху.

![](pictures/34.jpg)

Теперь с помощью инструмента «Отступ, X,Y» расположим наши подписи ровно посередине.

![](pictures/35.jpg)

## Масштаб подписей и маркеров

На данный момент при отдалении карты, все подписи и маркеры будут отображаться, что затруднит работу с большим массивов данных, поэтому разберёмся как сделать, чтобы этого избежать.

![](pictures/36.jpg)

Для того, чтобы подписи отображались при определённом масштабе в свойстве слоя выбираем вкладку «Подписи» - «Отрисовка». Ставим галочку на «Видимость в пределах масштаба» и выбираем наиболее удобное верхнее и нижнее значение для отображения подписи маркеров.

![](pictures/37.jpg)

Для маркеров перейдём во вкладку «Отрисовка», ставим галочку на «Видимость в пределах масштаба» и также как с подписью ставим удобное верхнее и нижнее значение. Теперь маркеры не будут отображаться при определённом отдалении.

![](pictures/38.jpg)

## Условная стилизация

Перейдём к изменению маркеров в зависимости от определённых условий (например, о исправности и неисправности водоисточника). Сейчас на данном этапе все водоисточники отображаются как рабочие, чтобы постоянно не проходить все шаги к изменению маркеров, введём алгоритм изменения водоисточника.

Для этого перейдём в свойства слоя, во вкладку «Стиль» и сверху в выпадающем списке выберем «Символизация на основе правил».

![](pictures/39.jpg)

Мы наблюдаем поле «Правило», в котором прописана формула, по которой будет происходить действия (как в Visio и Excel). Сейчас прописана логика, что поле «Тип» должно подходить под значение (тип водоисточника) и в этом случае у нас будет вид маркера, который у нас установлен.

Добавим новое поле, отображающее исправность водоисточника. Для этого переходим во вкладку «Поля», нажимаем «Добавить поле», пишем имя поля «Испр.» (исправность) и вводим тип поля «Целое число (integer 32 бита)». Нажимаем «ОК». Выходим из режима редактирования и сохраняем изменения.

![](pictures/40.jpg)

Заходим в таблицу атрибутов слоя и вводим значения исправности водоисточников: неисправные (цифра 0) и исправные (цифра 1). Выходим из режима редактирования и сохраняем изменения.

![](pictures/41.jpg)

Переходим обратно в свойства слоя, а именно в «Стиль». Теперь в окне «Символизация на основе правил» в строке правило пишем следующее для всех значения:

![](pictures/42.png)

:::{.callout-note}
## Примечание

Если есть водоисточники у которых установлено значение «0», то они пропадут с карты.
:::

Создадим теперь визуализацию неисправных маркеров. Для этого нажимаем правой кнопкой мыши на маркер и выбираем «Копировать», далее нажимаем в свободнее пространство также правой кнопкой мыши и выбираем «Вставить». У нас появилась копия маркера.

![](pictures/43.png)

Делаем так со всеми маркерами. Теперь для копий в строке «Правило» заменяем «1» на «0».

![](pictures/44.png)

Меняем иконки для данных маркеров на иконки с припиской _bad.

![](pictures/45.png)

Нажимаем «Применить» и наблюдаем изменения.

![](pictures/46.png)

Теперь мы можем скрывать/отображать рабочие и нерабочие водоисточники в слоях.

Также в настройках стиля возможно поменять название иконок.

![](pictures/47.png)

Мы разобрались с отображением иконок, согласно их работоспособности, однако надписи до сих пор остаются синими. Для этого переходим во вкладке «Подписи» в «Подписи на основе правил». Два раза нажимаем на подпись и выбираем «Конструктор выражений».

![](pictures/48.png)

В открывшемся окне выбираем «Поля и значения» - два раза нажмаем на «Испр.» и подписываем «=1». Для уточнения в поле «Описание» пишем «Испр.». Нажимаем «ОК».

![](pictures/49.png)

Создадим теперь второй файл подписи для неисправных водоисточников. Для этого копируем и вставляем имеющийся файл, меняем цвет на красный и в конструкторе выражений меняем «1» на «0». Также меняем описание на «Неиспр.». Нажимаем «Применить», «ОК» и наблюдаем, что поменялось.

![](pictures/50.png)

## Подписи с соответствии с боевым уставом ПО
В соответствии с боевым уставом подразделений пожарной охраны подписи к водоисточникам должны выглядеть так:

![](pictures/51.png)

Сделаем подписи пожарных гидрантов, согласно изображению выше. Заходим в свойства стиля на вкладку «Подписи» и нажимаем 2 раза на нашу подпись. Открываем вкладку «Форматирование».

![](pictures/52.png)

В данном разделе есть поле «Перенос строки по символу» нажимаем в ней на «Пробел», это значит, что наша строка будет организовываться в несколько строк по пробелу. Нажимаем «ОК» и «Применить».

![](pictures/53.png)

Наблюдаем, как теперь располагаются подписи. Делаем тоже самое для неисправных водоисточников.

![](pictures/54.png)

Теперь сделаем текст гидранта справа от него. Переходим всё также в параметры подписей. Нажимаем два раза на текст и во вкладке размещение выбираем размещение справа. При необходимости поправляем с помощью «Отступ по X, Y». Делаем тоже самое для неисправных водоисточников.

![](pictures/55.png)

![](pictures/56.png)

Подписи почти готовы. Теперь нужно добавить горизонтальную черту посередине. Для этого переходим во вкладку «Подписи», копируем и вставляем выбранную подпись. Теперь для исправных гидрантов у нас будет отображаться две подписи, которые накладываются друг на друга. Разместим копию подписи на нижнюю правую позицию. А оригинал подписи на верхнюю правую позицию. Стираем пробел в пункте «Перенос по пробелу», а также сделаем разницу по координатам Y, чтобы всё могло работать. Делаем тоже самое для неисправных водоисточников.

![](pictures/57.png)

![](pictures/58.png)

Добавим подчеркивание для верхней подписи.

![](pictures/59.png)

Уменьшим разницу по координатам Y, чтобы был вид, согласно примеру. Делаем тоже самое для неисправных водоисточников.

![](pictures/60.png)

Сейчас главная проблема состоит в том, что подписи у нас отображаются одинаковыми. Разобьём их на две строки, для этого переходим в таблицу атрибутов слоя. Нажимаем «Открыть калькулятор полей».

![](pictures/61.png)

В открывшемся окне вводим имя в поле «Имя поля», например «Подпись 1», тип поля «Текст», а размер например «30».

![](pictures/62.png)

С настройками поля мы закончили, теперь переходим к функциям. Выбираем функцию «Строки» - «strpos» и нажимаем на неё два раза. Теперь выбираем поле с которым мы работаем, для этого нажимаем «Поля и значения» и два раза нажимаем на «Подпись». Далее пишем запятую и в одинарных кавычках указываем знак пробела (Пример: ‘ ‘ ). 

![](pictures/63.png)

Теперь нам нужно выделить левую часть строки до пробела. Для этого понадобится функцию «Строки» - «left». Далее необходимо указать строку «Подпись» и поставить запятую со скобками. Нажимаем «ОК». 

![](pictures/64.png)

С левой частью мы разобрались, теперь надо сделать правую часть. Также заходим в калькулятор полей, вводим имя «Подпись 2», выбираем тип «Текст» и ставим размер «30». Вставляем формулу изображенную ниже и нажимаем «ОК»:

![](pictures/65.png)

Выходим из режима редактирования и сохраняем изменения, закрываем таблицу атрибутов. Всё что нам осталось сделать, это в свойствах слоя поменять наши подписи. Меняем значение для верхнего текста на «Подпись 1», а для нижнего на «Подпись 2».

![](pictures/66.png)

Применяем изменения и смотрим, что у нас получилось. По желанию редактируем отступ у подписей.

![](pictures/67.png)

## Подготовка атласа к печати

В этом разделе рассмотрим непосредственно планшет водоисточников в печатном виде, который можно использовать в пожарном подразделении. Для качественной работы с атласом обязаны быть атрибуты как подпись и адрес, поэтому если такие не имеются, необходимо их добавить.

![](pictures/68.png)

Нам необходимо создать макет, для этого заходим в «Проект» и выбираем «Создать макет…».

![](pictures/69.png)

Вводим название, например «Планшет» и нажимаем «ОК».

Нам открывается второе рабочее пространство для NextGIS QGIS, здесь мы будем выстраивать макеты. Макет – это подготовка нашей карты к печати. Т.е. в макете мы работаем с представлением карты, которую будем отправлять на печать. Первое, что необходимо сделать, это добавить карту. Для этого выбираем инструмент «Добавить карту» и левой кнопкой мыши размещаем на листе, например, как на изображении ниже. По желанию возможно переместить карту, просто перетаскивая её.

![](pictures/70.png)

Для перемещения расположения камеры в самой карте, нужно выбрать инструмент «Перемещение содержимого элемента». С этим инструментом мы можем перемещать, отдалять и приближать камеру в самой карте. 

![](pictures/71.png)

Возможен такой вариант, что нужен будет не альбомный вариант планшет, а книжный. Для смены формата выбираем инструмент «Выделить/переместить элемент», это нужно, чтобы переключаться между другими элементами, либо это можно делать через окно «Элементы» справа.

![](pictures/72.png)

После выбора инструмента, нажимаем на пустое место листа (белое пространство) и справа появятся «Свойства элемента», меняем ориентацию с альбомной на книжную.

![](pictures/73.png)

**На примере мы будем разбирать альбомный вариант.**

Добавим таблицу данных, которая будет отображать нам информацию, располагающихся на рабочем листе, т.е. только тех, которые мы видим. Выбираем инструмент «Добавить таблицу атрибутов».

![](pictures/74.png)

Размещаем таблицу атрибутов в любом удобном месте. В данный момент находятся все атрибуты, которые написаны в таблицу.

![](pictures/75.png)

Выбираем таблицу с помощью «Выделить/переместить элемент» и справа переходим во вкладку «Свойства элемента». Нажимаем на кнопку «Атрибуты».

![](pictures/76.png)

В открывшемся окне удаляем лишние столбцы, для этого выделяем, например столбец «Владелец» и нажимаем на красный минус.

![](pictures/77.png)

Оставляем столбцы с названием гидранта, его типом, водоотдачу и адрес расположения. Если вы случайно удалили нужное поле или хотите добавить новое поле в макет, нужно нажать на зелёный плюс и в выпадающем столбце нового столбца выбираем нужную информацию. Нажимаем «ОК».

![](pictures/78.png)

Для того, чтобы отображать атрибуты только видимых водоисточников, необходимо также в таблице атрибутов найти форму «Только объекты, видимые на карте» и поставить в ней галочку. Далее выбираем из выпадающего списка нашу карту.

![](pictures/79.png)

Испытываем наши настройки и наблюдаем, что таблица меняется в зависимости от гидрантов на карте. В принципе для минимума планшета водоисточника хватит, однако разберём дополнительные инструменты. Добавим подпись. Для этого выбираем инструмент «Добавить надпись».

![](pictures/80.png)

Располагаем текст в любом удобном месте и можем настроить его во вкладке «Внешний вид».

![](pictures/81.png)

Добавим элемент легенды. Для этого выбираем инструмент «Добавить легенду».

![](pictures/82.png)

Располагаем легенду в удобном для этого месте. В примере представлен только пожарный гидрант, однако на вашей карте будут отображаться все элементы ИННПВ, которые вы добавили. Чтобы удалить ненужные маркеры, нужно выделить маркер и нажать на красный минус.

![](pictures/83.png)

Добавим масштабную линейку. Для этого выбираем инструмент «Добавить масштабную линейку».

![](pictures/84.png)

Размещаем в любое удобное место.

![](pictures/85.png)

Добавим направление «север-юг». Для этого выбираем инструмент «Добавить указатель север-юг».

![](pictures/86.png)

Размещаем в любое удобное место.

![](pictures/87.png)

На данном этапе у нас создан планшет для одного фрагмента, т.е. мы можем печатать каждый раз новый фрагмент, однако это неудобно. Для этого и создан «Атлас». Перед работой с атласом, сохраним наш проект, нажав на дискрету сверху и вернёмся к карте.

![](pictures/88.png)

Нам нужно разбить нашу карту, с которой мы будем работать на те фрагменты, которые будут отражаться в макете. Для этого создаём новый слой GeoPackage. Выбираем тип геометрии «Полигон» и нажимаем «ОК».

![](pictures/89.png)

Заходим в режим редактирование и выбираем инструмент «Добавить полигональный объект».

![](pictures/90.png)

И рисуем полигон в нескольких (произвольно) разных местах, тем самым разделяя наш макет на несколько частей. Нажимаем левой кнопкой мыши, выбираем вершины полигона и при завершении нажимаем правую кнопку мыши, тем самым сохраняя полигон. Проделываем так со всеми частями карты. Выйдем из режима редактирования и сохраним.

![](pictures/91.png)

Теперь поменяем полную заливку на одну обводку, для этого заходим в стиль и выбираем только обводку, нажимаем «Применить» и «ОК».

![](pictures/92.png)

Заходим в наш макет. Сверху выбираем «Атлас» - «Настройки атласа» справа появилась вкладка «Атлас», ставим галочку на «Создать атлас».

![](pictures/93.png)

Выбираем слой покрытия нашего полигона и имя границы.

![](pictures/94.png)

Нажимаем на нашу карту и переходим в свойства элемента и ставим галочку на «Настройки масштаба атласа».

![](pictures/95.png)

Для проверки работоспособности сверху нажимаем на «Предпросмотр атласа» и нажимаем на стрелочки, тем самым наблюдая за передвижением камеры.

![](pictures/96.png)

Теперь наш атлас готов к печати! Если вам мешают границы полигона, то в параметрах атласа можно использовать «Скрыть слой покрытия».

![](pictures/97.png)

Для печати атласа заходим во вкладку «Атлас» и выбираем «Печать атласа…»

![](pictures/98.png)

Для сохранения атласа в изображение, выбираем инструмент «Экспорт атласа в изображения…». Выбираем путь, настройки нашего будущего изображения и нажимаем «Сохранить».

Получим фотографии нашего атласа.

![](pictures/99.png)